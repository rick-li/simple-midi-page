<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>No Unmute 測試</title>
    <link rel="stylesheet" type="text/css" href="reset.css">
    <script src="bundle.js"></script>
    <script>

const USER_ACTIVATION_EVENTS = [
  'auxclick',
  'click',
  'contextmenu',
  'dblclick',
  'keydown',
  'keyup',
  'mousedown',
  'mouseup',
  'touchend'
]

let AudioContext = window.webkitAudioContext

// To detect iOS, check for iOS user agent (spoofed by many mobile browsers)
// and confirm Safari-only webkitAudioContext is present.
const IS_IOS = /iPhone|iPad|iPod/.test(navigator.userAgent) && AudioContext != null

function init () {
//   if (!IS_IOS) return
    if(!AudioContext){
        AudioContext = window.AudioContext
    }
  // state can be 'blocked', 'pending', 'allowed'
  let htmlAudioState = 'blocked'
  let webAudioState = 'blocked'

  let audio
  let context
  let source

  const sampleRate = (new AudioContext()).sampleRate
  const silentAudioFile = createSilentAudioFile(sampleRate)

  USER_ACTIVATION_EVENTS.forEach(eventName => {
    window.addEventListener(
      eventName, handleUserActivation, { capture: true, passive: true }
    )
  })

  // Return a seven samples long 8 bit mono WAVE file
  function createSilentAudioFile (sampleRate) {
    const arrayBuffer = new ArrayBuffer(10)
    const dataView = new DataView(arrayBuffer)

    dataView.setUint32(0, sampleRate, true)
    dataView.setUint32(4, sampleRate, true)
    dataView.setUint16(8, 1, true)

    const missingCharacters =
      window.btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)))
        .slice(0, 13)

    return `data:audio/wav;base64,UklGRisAAABXQVZFZm10IBAAAAABAAEA${missingCharacters}AgAZGF0YQcAAACAgICAgICAAAA=`
    //"RIFF+WAVEfmt "
    //"]A       "
  }

  function handleUserActivation (e) {
    if (htmlAudioState === 'blocked') {
      htmlAudioState = 'pending'
      createHtmlAudio()
    }
    if (webAudioState === 'blocked') {
      webAudioState = 'pending'
      createWebAudio()
    }
  }

  function createHtmlAudio () {
    audio = document.createElement('audio')

    audio.setAttribute('x-webkit-airplay', 'deny') // Disable the iOS control center media widget
    audio.preload = 'auto'
    audio.loop = true
    audio.src = silentAudioFile
    audio.load()

    audio.play().then(
      () => {
        htmlAudioState = 'allowed'
        maybeCleanup()
      },
      () => {
        htmlAudioState = 'blocked'

        audio.pause()
        audio.removeAttribute('src')
        audio.load()
        audio = null
      }
    )
  }

  function createWebAudio () {
    context = new AudioContext()

    source = context.createBufferSource()
    source.buffer = context.createBuffer(1, 1, 22050) // .045 msec of silence
    source.connect(context.destination)
    source.start()

    if (context.state === 'running') {
      webAudioState = 'allowed'
      maybeCleanup()
    } else {
      webAudioState = 'blocked'

      source.disconnect(context.destination)
      source = null

      context.close()
      context = null
    }
  }

  function maybeCleanup () {
    if (htmlAudioState !== 'allowed' || webAudioState !== 'allowed') return

    USER_ACTIVATION_EVENTS.forEach(eventName => {
      window.removeEventListener(
        eventName, handleUserActivation, { capture: true, passive: true }
      )
    })
  }
}



    </script>
    <style>
        html,body{
            height: 100%;
        }
        body{
            color: black;
        }
        .container {
            height: 100%;
            background-color: gray;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            
            
        }
        .state-stop {
            background-image: url(/start.svg);
        }
        .state-start {
            background-image: url(/stop.svg);
        }
        #music_btn{
            background-repeat: no-repeat;
            background-size: 80px 80px;
            height: 80px;
            width: 80px;
            cursor: pointer;
        }
        #music_name{
            font-size: 32px;
            height: 80px;
        }
    </style>
    <script>
        //緩存控制
        // if ('serviceWorker' in navigator) {
        //     console.log('CLIENT: service worker registration in progress.');
        //     navigator.serviceWorker.register('/cache.service.worker.js').then(function() {
        //         console.log('CLIENT: service worker registration complete.');
        //     }, function() {
        //         console.log('CLIENT: service worker registration failure.');
        //     });
        // } else {
        //     console.log('CLIENT: service worker is not supported.');
        // }

        // var player = new Timidity('https://timidity.oss-cn-hongkong.aliyuncs.com/');
        //從阿里雲oss加載midi庫
        // var player = new Timidity('https://timidity-shanghai.oss-cn-shanghai.aliyuncs.com/');
        var player = new Timidity('/');
        
        window.onload = function(){
            // UnmuteIosAudio();
            init();
            var startTime = 0;
            var oneHour = 60 * 60 * 1000;
            document.querySelector("#music_btn").
            addEventListener('click',function(e){
                
                if(e.target.className == 'state-stop') {
                    e.target.className = 'state-start';
                    console.log('started.');
                    startTime = new Date().getTime();
                    player.load('bach.mid');//因為timidity默認指向了公共服務，此處要用絕對路徑加載midi文件
                    player.play();
                }else {
                    startTime = 0;
                    e.target.className = 'state-stop';
                    console.log('stop.');
                    player.pause()
                }
                
            });
            player.on('ended', function() {
                //如果不足一小時則繼續播放。
                if((new Date().getTime() - startTime) < oneHour){
                    console.log('less than 1 hour, continue');
                    fetch('/log')
                    player.play();
                }else {
                    console.log('ended');
                }

            });
            // player.on('unstarted', () => console.log('unstarted'))
            // player.on('playing', () => console.log('playing'))
            // player.on('paused', () => console.log('paused'))
            
                // player.on('buffering', () => console.log('buffering'))
                // player.on('timeupdate', (time) => console.log('timeupdate', time))
            player.on('error', function(err){
                console.log('error', err);
            });
        }


       

        
    </script>
</head>
<body >
    <div class="container">
        <div id="music_name" >Bach bwv988.mid</div>
        <div id="music_btn" class="state-stop"></div>
    </div>
    
</body>
</html>